<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ú–æ–π ChatGPT</title>
  <style>
    :root {
      --bg: #f0f2f5; --panel: #ffffff; --bot: #e5e5ea;
      --user1: #4facfe; --user2: #00f2fe; --text: #111;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;color:var(--text);display:flex;flex-direction:column}
    header{padding:14px 18px;font-weight:700;font-size:18px}
    .wrap{width:min(920px,100%);margin:0 auto;padding:0 12px 16px;display:flex;flex-direction:column;gap:12px;flex:1}
    #chat-box{flex:1;min-height:60vh;background:var(--panel);border-radius:16px;padding:16px;overflow-y:auto;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .row{display:flex;margin:10px 0}.row.user{justify-content:flex-end}.row.bot{justify-content:flex-start}
    .bubble{max-width:78%;padding:12px 16px;border-radius:18px;line-height:1.45;position:relative;box-shadow:0 2px 6px rgba(0,0,0,.08);animation:fadeIn .18s ease-out;word-wrap:break-word;white-space:pre-wrap}
    .bubble.user{color:#fff;background:linear-gradient(135deg,var(--user1),var(--user2));border-bottom-right-radius:6px}
    .bubble.user::after{content:"";position:absolute;right:-8px;bottom:0;border-left:10px solid var(--user1);border-top:10px solid transparent}
    .bubble.bot{background:var(--bot);color:var(--text);border-bottom-left-radius:6px}
    .bubble.bot::after{content:"";position:absolute;left:-8px;bottom:0;border-right:10px solid var(--bot);border-top:10px solid transparent}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    .composer{display:flex;gap:10px;background:var(--panel);border-radius:14px;padding:10px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    textarea{flex:1;border:none;resize:none;outline:none;padding:10px 12px;border-radius:10px;font-size:15px;max-height:30vh}
    button{border:none;border-radius:10px;padding:0 18px;background:linear-gradient(135deg,var(--user1),var(--user2));color:#fff;font-weight:600;cursor:pointer;min-width:110px;height:44px}
    button:disabled{opacity:.6;cursor:default}.hint{font-size:12px;opacity:.7;padding:0 4px}
    /* —á—É—Ç—å –ø–æ–¥–∂–∏–º–∞–µ–º —Ñ–æ—Ä–º—É–ª—ã –≤–Ω—É—Ç—Ä–∏ –ø—É–∑—ã—Ä—è */
    .bubble .MathJax{line-height:1.2}
  </style>

  <!-- MathJax –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']]
      },
      options: {
        skipHtmlTags: ['script','noscript','style','textarea','pre','code']
      }
    };
  </script>
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º MathJax (—Ä–µ–Ω–¥–µ—Ä –≤ HTML/CSS) -->
  <script id="MathJax-script" async
          src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
</head>
<body>
  <div class="wrap">
    <header>üí¨ ChatGPT</header>

    <div id="chat-box" aria-live="polite"></div>

    <div class="composer">
      <textarea id="msg" rows="2" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ... (Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, Shift+Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞)"></textarea>
      <button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
    <div class="hint">
  ¬© 2025 –ö–æ–º–ø–∞–Ω–∏—è ¬´–ò–°–≠¬ª. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.
</div>
  </div>

  <script>
    const chat = document.getElementById('chat-box');
    const input = document.getElementById('msg');
    const sendBtn = document.getElementById('send');

    function addMessage(html, who='user') {
      const row = document.createElement('div');
      row.className = 'row ' + (who === 'user' ? 'user' : 'bot');
      const bub = document.createElement('div');
      bub.className = 'bubble ' + (who === 'user' ? 'user' : 'bot');

      // –í–ê–ñ–ù–û: innerHTML –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã MathJax –≤–∏–¥–µ–ª $...$
      bub.innerHTML = html;
      row.appendChild(bub);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;

      // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –ø—É–∑—ã—Ä—è ‚Äî –±—ã—Å—Ç—Ä–µ–µ
      if (window.MathJax && MathJax.typesetPromise) {
        MathJax.typesetPromise([bub]).catch(console.error);
      }
    }

    async function askLLM(msg) {
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({message: msg})
      });
      const data = await res.json().catch(()=> ({}));
      if (data.reply) return data.reply;
      throw new Error(data.details || data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
    }

    async function send() {
      const msg = input.value.trim();
      if (!msg) return;
      addMessage(msg, 'user');
      input.value = '';
      input.focus();
      sendBtn.disabled = true;

      try {
        const reply = await askLLM(msg);
        addMessage(reply, 'bot');
      } catch (e) {
        addMessage('‚ùå ' + e.message, 'bot');
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener('click', send);
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
    });

    addMessage('–ü—Ä–∏–≤–µ—Ç!, 'bot');
  </script>
</body>
</html>
