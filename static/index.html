<!DOCTYPE html>
<html lang="ru">
<head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Assistent ISE</title>
  <link rel="stylesheet" href="style.css">
  <!-- MathJax –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.9/dist/purify.min.js"></script>
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']]
      },
      options: {
        skipHtmlTags: ['script','noscript','style','textarea','pre','code']
      }
    };
  </script>
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º MathJax (—Ä–µ–Ω–¥–µ—Ä –≤ HTML/CSS) -->
  <script id="MathJax-script" async
          src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
</head>
<body>
  <div class="wrap">
<header>üí¨ Assistent ISE</header>

<div class="wrap">
  <div id="chat-box" aria-live="polite"></div>

  <div class="composer">
    <div class="input-box">
      <textarea id="msg" rows="1" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
      <button id="send" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
        </svg>
      </button>
    </div>
  </div>

  <div class="hint">
    ¬© 2025 –ö–æ–º–ø–∞–Ω–∏—è ¬´–ò–°–≠¬ª. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.
  </div>
</div>


<script>
  const chat = document.getElementById('chat-box');
  const input = document.getElementById('msg');
  const sendBtn = document.getElementById('send');

function addMessage(html, who='user') {
  const row = document.createElement('div');
  row.className = 'row ' + (who === 'user' ? 'user' : 'bot');

  const bub = document.createElement('div');
  bub.className = 'bubble ' + (who === 'user' ? 'user' : 'bot');

  if (who === 'user') {
    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –≤—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç
    bub.textContent = html;
  } else {
    // –û—Ç–≤–µ—Ç –±–æ—Ç–∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ —Ñ–∏–ª—å—Ç—Ä
    const clean = DOMPurify.sanitize(html, {
      ALLOWED_TAGS: ['b','i','strong','em','a','code','pre','p','br'],
      ALLOWED_ATTR: ['href','title','target']
    });
    bub.innerHTML = clean;
  }

    // --- –¥–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è ---
    const time = document.createElement('div');
    time.className = 'time';
    const now = new Date();
    time.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
    bub.appendChild(time);

    row.appendChild(bub);
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;

    if (window.MathJax && MathJax.typesetPromise) {
      MathJax.typesetPromise([bub]).catch(console.error);
    }
  }

  async function askLLM(msg) {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({message: msg})
    });
    const data = await res.json().catch(()=> ({}));
    if (data.reply) return data.reply;
    throw new Error(data.details || data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
  }

  async function send() {
    const msg = input.value.trim();
    if (!msg) return;
    addMessage(msg, 'user');
    input.value = '';
    input.focus();
    sendBtn.disabled = true;

    try {
      const reply = await askLLM(msg);
      addMessage(reply, 'bot');
    } catch (e) {
      addMessage('‚ùå ' + e.message, 'bot');
    } finally {
      sendBtn.disabled = false;
    }
  }

  sendBtn.addEventListener('click', send);
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      send();
    }
  });

  // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  document.addEventListener('DOMContentLoaded', () => {
    addMessage('–ü—Ä–∏–≤–µ—Ç! üëã –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?', 'bot');
  });
</script>
</body>
</html>
